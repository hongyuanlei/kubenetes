# 创建用户认证授权的 kubeconfig 文件

## Create private key

```shell
$ openssl genrsa -out ylhong.key 2048
$ openssl req -new -key ylhong.key -out ylhong.csr -subj "/CN=ylhong/O=test-group"
$ cat ylhong.csr | base64 | tr -d "\n"
LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ2F6Q0NBVk1DQVFBd0pqRVBNQTBHQTFVRUF3d0dlV3hvYjI1bk1STXdFUVlEVlFRS0RBcDBaWE4wTFdkeQpiM1Z3TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUE1Y25tSGNaRFBUYlRNcXpUCnRUU05waG5kQVZQN2ljV1daTjNPalhJaXB4dWZuaEhkYTA5OFl2TEVjemNYb2ZvZHJBYnBtdHMrSnN5ODE0YzQKbFl1QWJiTGMxMkloayt0bUFJVEt4NXUvaFF1d1oyVFR5ZllPRHcrbmN4a2JxWnB4ZTNyQjFIYmloYkpQd1g2aApMdWRNMWFLa05hb3lhZXdTbjdmS0c5ZmRwMzJuZE1meE5RT0E4d2hMQTYwTFpyc1BCQmtZZlZqbEE3dllDTGczClExKzdZdUluV2Y3V0tEVmZ2UXJtWWJjS1FVNFhESm1ud2VlbytjWlVqUG5BVk8rQm01YmlTdW5PV0prU0RqSzEKcVJqeXZndFdGNzg2MnYyRWtVSkpZZ2xmRFZrakVwUER4b1JsNmE1Zm9XMUNqeDhaNlpEVlplS2crQXNoM05pSQpDZ2dDc1FJREFRQUJvQUF3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUlKZTlNbWdLT0ptOHZhNmtvNFV0bm5tCnIwV0Zzb2Y0NlB5QlNIMTZmZWdGZjNrK1BFMTIydi9hQTFDMEFXZFpKZWpyYldOQmdEM1d0TFlnK1ZudXJtRXYKQTdmamUvNXJFckhOazN1dnhwK29TeHhDSlR4aEdZMEx1ME82TWx0eXExNnNLMTBSYnpWSXpndUtFWU5PUFN0ZQpxNlB4ZXYxeENKVVRTNUx6MUk0bjZwd2xyWTdrZU5UcGQvZ2hRK3Y4Q2FESEF1cS9sSlhYL1gvTzYvKzBVS1lXCngyRUlxZ3hmNFJPM1RVTEo2T2cwY2RDQm1RaEZUNUFvWVAwUFVSRmhucDJ5RHlhNUUyUVlnMzZNTG5pN29lRE4KWGFaelZBNGpSRER0WVVYTUxHS2pJSlY0UnhCQzZTcXoxZzdNYTFzaDVyN0I0VDVTa3RqQ2tQcTNUdFk2RytJPQotLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0K
```
## Create a CertificateSigningRequest
```shell
cat <<EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: ylhong
spec:
  signerName: kubernetes.io/kube-apiserver-client
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ2F6Q0NBVk1DQVFBd0pqRVBNQTBHQTFVRUF3d0dlV3hvYjI1bk1STXdFUVlEVlFRS0RBcDBaWE4wTFdkeQpiM1Z3TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUE1Y25tSGNaRFBUYlRNcXpUCnRUU05waG5kQVZQN2ljV1daTjNPalhJaXB4dWZuaEhkYTA5OFl2TEVjemNYb2ZvZHJBYnBtdHMrSnN5ODE0YzQKbFl1QWJiTGMxMkloayt0bUFJVEt4NXUvaFF1d1oyVFR5ZllPRHcrbmN4a2JxWnB4ZTNyQjFIYmloYkpQd1g2aApMdWRNMWFLa05hb3lhZXdTbjdmS0c5ZmRwMzJuZE1meE5RT0E4d2hMQTYwTFpyc1BCQmtZZlZqbEE3dllDTGczClExKzdZdUluV2Y3V0tEVmZ2UXJtWWJjS1FVNFhESm1ud2VlbytjWlVqUG5BVk8rQm01YmlTdW5PV0prU0RqSzEKcVJqeXZndFdGNzg2MnYyRWtVSkpZZ2xmRFZrakVwUER4b1JsNmE1Zm9XMUNqeDhaNlpEVlplS2crQXNoM05pSQpDZ2dDc1FJREFRQUJvQUF3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUlKZTlNbWdLT0ptOHZhNmtvNFV0bm5tCnIwV0Zzb2Y0NlB5QlNIMTZmZWdGZjNrK1BFMTIydi9hQTFDMEFXZFpKZWpyYldOQmdEM1d0TFlnK1ZudXJtRXYKQTdmamUvNXJFckhOazN1dnhwK29TeHhDSlR4aEdZMEx1ME82TWx0eXExNnNLMTBSYnpWSXpndUtFWU5PUFN0ZQpxNlB4ZXYxeENKVVRTNUx6MUk0bjZwd2xyWTdrZU5UcGQvZ2hRK3Y4Q2FESEF1cS9sSlhYL1gvTzYvKzBVS1lXCngyRUlxZ3hmNFJPM1RVTEo2T2cwY2RDQm1RaEZUNUFvWVAwUFVSRmhucDJ5RHlhNUUyUVlnMzZNTG5pN29lRE4KWGFaelZBNGpSRER0WVVYTUxHS2pJSlY0UnhCQzZTcXoxZzdNYTFzaDVyN0I0VDVTa3RqQ2tQcTNUdFk2RytJPQotLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0K
  expirationSeconds: 31536000  # one year
  usages:
  - client auth
EOF
```
## Approve the CertificateSigningRequest
- Get the list of CSRs: 
``` shell
$ kubectl get csr
NAME     AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION
ylhong   2m    kubernetes.io/kube-apiserver-client   kubernetes-admin   365d                Pending
```
- Approve the CSR:
```shell
$ kubectl certificate approve ylhong
certificatesigningrequest.certificates.k8s.io/ylhong approved
```
- Get the certificate

```shell
$ kubectl get csr/ylhong -o jsonpath="{.status.certificate}" | base64 -d | tee ylhong.crt
```

## Create Role and RoleBinding
This is a sample command to create a Role for this new user:
```shell
$ kubectl create role developer --verb=create --verb=get --verb=list --verb=update --verb=delete --resource=pods
role.rbac.authorization.k8s.io/developer created
```
This is a sample command to create a RoleBinding for this new user:
```shell
$ kubectl create rolebinding developer-binding-ylhong --role=developer --user=ylhong
rolebinding.rbac.authorization.k8s.io/developer-binding-ylhong created
```
## Add to kubeconfig

First, you need to add new credentials:
```shell
kubectl config set-credentials ylhong \
  --client-key <(echo -n "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRRGx5ZVlkeGtNOU50TXkKck5PMU5JMm1HZDBCVS91SnhaWmszYzZOY2lLbkc1K2VFZDFyVDN4aThzUnpOeGVoK2gyc0J1bWEyejRtekx6WApoemlWaTRCdHN0elhZaUdUNjJZQWhNckhtNytGQzdCblpOUEo5ZzRQRDZkekdSdXBtbkY3ZXNIVWR1S0Zzay9CCmZxRXU1MHpWb3FRMXFqSnA3QktmdDhvYjE5Mm5mYWQweC9FMUE0RHpDRXNEclF0bXV3OEVHUmg5V09VRHU5Z0kKdURkRFg3dGk0aWRaL3RZb05WKzlDdVpodHdwQlRoY01tYWZCNTZqNXhsU00rY0JVNzRHYmx1Sks2YzVZbVJJTwpNcldwR1BLK0MxWVh2enJhL1lTUlFrbGlDVjhOV1NNU2s4UEdoR1hwcmwraGJVS1BIeG5wa05WbDRxRDRDeUhjCjJJZ0tDQUt4QWdNQkFBRUNnZ0VBQXNQZVVxVW1QYncxU0NhemdQcVdDa1hGSnEwUXFiQ2duY3ZiL3BCOUtZTGYKOWJaY0VseWhYK3p4TDN3K0d1OUFNR2ZnWTRKSUlnNGtaeGtMMWFQWk9xaTBkdHlKMENaODRweDJkcmF4ZEN2Rwo5b1dNZFdHU08zenFIRXpVN0FKdFkybWZuN3VEQUE0Y1h0VVQ0alU3RTlhS1VKR0EzQXl3MEM1MVhvYW5Wb3E3CkU3QWJMTUViQUhVV3c4WG9QTEhnZG5CZCtNOXZzQTBaTWdzbnBnb0s0R2xwcy8zNER2UUZ3TWQwQlRGLzg4S04KR1MybjFtMUhpcHV0VzVFRlJZNVdGYnFwc0xrTnlsMllndU05WGpPTXlZOE9UYVoxSlJNOW9KY3ZjdzdDbUdEaQoxVVBIeVgvNFJBUXlJMnl1cXpGR3I3RWZsZW56U3NJOW5ITzR0SHAyd1FLQmdRRDhvZU1TdXFKZWRDYnIzMXprCmFYWkRZSWhNby9SSEJjYTU0SnhLZVRxY1dRVnlPZ3RNUkkyaERGSWtjNFE2ZGpRb3dmTXZFdUg1YWhrUUdaejIKQVlveWFvT1Q4VzBQdjg4U1VxbWZjMzg0MFMxSUViWG5HYnBjN0RXWFNvaXZmVnJBSE9ESXJKd1lWd1VibS9tZApZZ3BWSTdZSTdKbDVNejMxN0NmdFV4MDZVUUtCZ1FEbzJnNnExQXR2S21rSGlsbFJ3OUM4SGdBLzRkempUVEZMClpQdUYwczZaRVhwUHkxK282bEwrYTRMNkgxOElyZGdlMUFyazZvMFo4eTZFSGpDOFY2bHUwZ3VBTnhSMUdQZlAKU2dBNEIzTllHWGpIWkxMc21RR3QyTTR4dFdhVjlEbVBiSGk4Y01mTHV5dGk1dC9WYkJNUUxOdzF3a1dqdER4Rgo0ekVGSDZIS1lRS0JnRGRVOWJrYWE0bW9nd1hTYkRRUzdUWWdwSG0weDBIdS8vR2lRbGtGYUZMcUpJazZNVk5KCkNJUW5nSzQvSnN6dktzbHFnV3JrQmQ1czRJUm9ON3FoNTdUWEkyNTV5RnRVdFhQYjZ3N2phdy8wc0toQ1NNY1AKR1lSVXNBQXM4UGNPeTV1Y041ZDhSc3dGOHpaeTJSOGhaQVgxeGw3NkF6dEtmOTJuRmErakxwbWhBb0dBTy8vTQpIYnFMdzdaQzMvMkhMR2x2aExtYVNOdXpKaUxDMi9HR1dpSkt0K2hvQXQyZHBaSFRsdGt2STdJbnM3M1AzWW0zCjBPcWJOeCtSVWR2UnBRWlZrMGV1VFBoa1hoUHo3c2JiclpSRjVXS1MyNVlZQUowZ2NLSlg1emtkMk8vWVVSdWIKTkxzKzBFRkhXYkd4NVhWMnFBbFhLTWNKV0xoZGU0aWlIZmJib3FFQ2dZQUVUS2RqNkJmaG5MVm1rRGlzaHJDVwp6MEo5M3V0dnVkUktlQUV3dVNCTHBJeFFLMXdEYWI5TzlIZzJIR3QveHBGUjRDZ0NuYUtMQVYzZ2ZQQ2R2a3Y2CmE3dGJmNjJsQVB4bTMxL0srWGVJMUFpMjJ2SnFvWkJ2RFBuQyt2YkFHUFpLcjcrSFJoMDB1WkhGeFZYVmFOeDUKRmdrT01kWUtsOFpLVkFhQVRQaFpHZz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K" | base64 -d) \
  --client-certificate <(echo -n "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURDekNDQWZPZ0F3SUJBZ0lRYzcyRGZJYnZzMWRKTXBkVk5WRDBTREFOQmdrcWhraUc5dzBCQVFzRkFEQVYKTVJNd0VRWURWUVFERXdwcmRXSmxjbTVsZEdWek1CNFhEVEl6TURreU1ERTBNREUwTTFvWERUSTBNRGt4T1RFMApNREUwTTFvd0pqRVRNQkVHQTFVRUNoTUtkR1Z6ZEMxbmNtOTFjREVQTUEwR0ExVUVBeE1HZVd4b2IyNW5NSUlCCklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUE1Y25tSGNaRFBUYlRNcXpUdFRTTnBobmQKQVZQN2ljV1daTjNPalhJaXB4dWZuaEhkYTA5OFl2TEVjemNYb2ZvZHJBYnBtdHMrSnN5ODE0YzRsWXVBYmJMYwoxMkloayt0bUFJVEt4NXUvaFF1d1oyVFR5ZllPRHcrbmN4a2JxWnB4ZTNyQjFIYmloYkpQd1g2aEx1ZE0xYUtrCk5hb3lhZXdTbjdmS0c5ZmRwMzJuZE1meE5RT0E4d2hMQTYwTFpyc1BCQmtZZlZqbEE3dllDTGczUTErN1l1SW4KV2Y3V0tEVmZ2UXJtWWJjS1FVNFhESm1ud2VlbytjWlVqUG5BVk8rQm01YmlTdW5PV0prU0RqSzFxUmp5dmd0VwpGNzg2MnYyRWtVSkpZZ2xmRFZrakVwUER4b1JsNmE1Zm9XMUNqeDhaNlpEVlplS2crQXNoM05pSUNnZ0NzUUlECkFRQUJvMFl3UkRBVEJnTlZIU1VFRERBS0JnZ3JCZ0VGQlFjREFqQU1CZ05WSFJNQkFmOEVBakFBTUI4R0ExVWQKSXdRWU1CYUFGTTN1c1ZmTnlIbjBJSDlpUUhQdndIL0ZjK1BJTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBZwpGM0o4VzlVa3lHZmJ4OUNpYjNwQmFKUnlOazVvZTJKeDcxNVA0RFYyN3FRcS9OOFNpOFFicUtyNCtqWVpvN1dHClNLV0hBRjk3NWZqSU9PamNwaURTeE9NcjJmMHNqNDBPNmhvaFVjdFVhZFBLUHZ1OUNYTlRVUFZiS2x4ZStvMnYKUHErU2pSQitvc01YeGtSYXp1WXpIa0Z4RlluQWpNQjZaNnV5RERUM0tUV0VqbVZTaUZ5U3hIc3dLWVBLclkySgpISVpMWVRXa2dVdlVhVnowSkFaQUh0aHhDYmI2d0dnMENSL2djdUtnUDRQYURUU01hczBidGVveENQUFdTczVICnd4OVJ5WXVqNm8wTmltTndndlYweUJ3OG9TOWpQTVVPN1c2ZjMxdFNtcTAwUS9mNHB2cjluZGRaZWRNbUJxYlMKS2paejduc09qZXhaYURpRVhrZUoKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=" | base64 -d) \
  --embed-certs=true 
```
OR
```shell
kubectl config set-credentials myuser --client-key=myuser.key --client-certificate=myuser.crt --embed-certs=true
```
Then, you need to add the context:
```shell
$ kubectl config set-context ylhong --cluster=kubernetes --user=ylhong
Context "ylhong" created.
```
To test it, change the context to ylhong:
```shell
$ kubectl config use-context ylhong
$ kubectl config get-contexts
CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE
          kubernetes-admin@kubernetes   kubernetes   kubernetes-admin
*         ylhong                        kubernetes   ylhong
```

